<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Perplexity Research Hub - Advanced AI-powered research tools">
    <title>Perplexity Research Hub</title>
    <style>
        :root {
            --primary-color: #0077b6;
            --secondary-color: #00b4d8;
            --dark-color: #121212;
            --light-color: #f8f9fa;
            --accent-color: #90e0ef;
            --text-color: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--dark-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }

        header {
            background-color: var(--primary-color);
            padding: 1rem;
            box-shadow: var(--box-shadow);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: clamp(1.5rem, 2vw, 2rem);
            font-weight: 700;
            color: var(--light-color);
            text-decoration: none;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 1.5rem;
        }

        nav ul li a {
            color: var(--light-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        nav ul li a:hover {
            color: var(--accent-color);
        }

        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            width: 100%;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background-color: #1e1e1e;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .panel h2 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
        }

        .panel p {
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: var(--dark-color);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-color);
        }

        .btn-primary:hover {
            background-color: #005f8a;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid #495057;
            background-color: #212529;
            color: var(--text-color);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        footer {
            background-color: var(--primary-color);
            color: var(--light-color);
            text-align: center;
            padding: 1rem;
            margin-top: auto;
        }

        .api-key-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #1e1e1e;
            border-radius: var(--border-radius);
        }

        .api-key-input {
            display: flex;
            margin-bottom: 1rem;
        }

        .api-key-input input {
            flex-grow: 1;
            margin-right: 1rem;
        }

        .usage-tracker {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #212529;
            border-radius: var(--border-radius);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 60vh;
            border: 1px solid #495057;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #495057;
        }

        .chat-input input {
            flex-grow: 1;
            margin-right: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            max-width: 80%;
        }

        .user-message {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .bot-message {
            background-color: #495057;
            border-bottom-left-radius: 0;
        }

        .citation-badge {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            margin: 0.25rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .citation-badge:hover {
            background-color: #ffdd57;
            transform: scale(1.05);
        }

        .credibility-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .high-credibility {
            background-color: #28a745;
        }

        .medium-credibility {
            background-color: #ffc107;
        }

        .low-credibility {
            background-color: #dc3545;
        }

        .search-results {
            margin-top: 1rem;
        }

        .search-result {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #212529;
            border-radius: var(--border-radius);
        }

        .search-result h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .search-result p {
            margin-bottom: 0.5rem;
        }

        .search-result .url {
            color: #adb5bd;
            font-size: 0.9rem;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .cache-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 1rem;
        }

        .stats-card {
            background-color: #212529;
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .stats-card h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .stats-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stats-card .description {
            color: #adb5bd;
            font-size: 0.9rem;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-item {
            padding: 0.5rem;
            border-bottom: 1px solid #495057;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            background-color: #212529;
        }

        .history-item.active {
            background-color: var(--secondary-color);
            color: var(--dark-color);
        }

        .research-projects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .project-card {
            background-color: #212529;
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .project-card h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .project-card p {
            color: #adb5bd;
            font-size: 0.9rem;
        }

        .fact-check-results {
            margin-top: 1rem;
        }

        .fact-check-item {
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #212529;
            border-radius: var(--border-radius);
        }

        .fact-check-item h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .fact-check-item .verdict {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .fact-check-item .verdict.true {
            color: #28a745;
        }

        .fact-check-item .verdict.misleading {
            color: #ffc107;
        }

        .fact-check-item .verdict.false {
            color: #dc3545;
        }

        .fact-check-item p {
            margin-bottom: 0.5rem;
        }

        .fact-check-item .source-link {
            color: #adb5bd;
            font-size: 0.9rem;
        }

        .refresh-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .refresh-indicator span {
            margin-left: 0.5rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .search-filters {
                grid-template-columns: 1fr;
            }

            .cache-stats {
                grid-template-columns: 1fr;
            }

            .header-container {
                flex-direction: column;
            }

            nav ul {
                margin-top: 1rem;
            }

            nav ul li {
                margin: 0 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="#" class="logo">Perplexity Research Hub</a>
            <nav>
                <ul>
                    <li><a href="#sonar-chat">Sonar Chat</a></li>
                    <li><a href="#search-api">Search API</a></li>
                    <li><a href="#cache-stats">Cache Stats</a></li>
                    <li><a href="#research-assistant">Research Assistant</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="api-key-management" class="api-key-section">
            <h2>API Key Management</h2>
            <div class="api-key-input">
                <input type="text" id="api-key" placeholder="Enter your API key">
                <button class="btn btn-primary" id="save-api-key">Save</button>
            </div>
            <div class="usage-tracker">
                <h3>Usage Tracking</h3>
                <div class="stats-card">
                    <h4>Total Requests</h4>
                    <div class="value" id="total-requests">0</div>
                    <div class="description">Total API requests made</div>
                </div>
                <div class="stats-card">
                    <h4>Tokens Used</h4>
                    <div class="value" id="tokens-used">0</div>
                    <div class="description">Total tokens consumed</div>
                </div>
                <div class="stats-card">
                    <h4>Estimated Cost</h4>
                    <div class="value" id="estimated-cost">$0.00</div>
                    <div class="description">Approximate cost based on usage</div>
                </div>
            </div>
        </section>

        <div class="dashboard">
            <div class="panel" id="sonar-chat">
                <h2>Sonar Chat</h2>
                <p>Interactive AI-powered chat with web-grounded responses and citation tracking.</p>
                <div class="form-group">
                    <label for="sonar-model">Select Model:</label>
                    <select id="sonar-model">
                        <option value="llama-3.1-sonar-small">Llama 3.1 Sonar Small</option>
                        <option value="llama-3.1-sonar-large">Llama 3.1 Sonar Large</option>
                        <option value="llama-3.1-sonar-huge-128k-online">Llama 3.1 Sonar Huge 128k Online</option>
                    </select>
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Chat messages will be displayed here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Type your message...">
                        <button class="btn" id="send-message">Send</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="follow-up-questions">Follow-up Questions:</label>
                    <select id="follow-up-questions" multiple>
                        <!-- Follow-up questions will be populated here -->
                    </select>
                </div>
                <button class="btn" id="fork-conversation">Fork Conversation</button>
                <button class="btn" id="verify-citations">Verify Citations</button>
            </div>

            <div class="panel" id="search-api">
                <h2>Search API</h2>
                <p>Advanced search with domain filters, source credibility scoring, and result clustering.</p>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="search-query">Search Query:</label>
                        <input type="text" id="search-query" placeholder="Enter your search query">
                    </div>
                    <div class="form-group">
                        <label for="domain-filter">Domain Filter:</label>
                        <select id="domain-filter" multiple>
                            <option value="all">All Domains</option>
                            <option value="edu">Educational (.edu)</option>
                            <option value="gov">Government (.gov)</option>
                            <option value="org">Organizations (.org)</option>
                            <option value="com">Commercial (.com)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date-range">Date Range:</label>
                        <select id="date-range">
                            <option value="any">Any Time</option>
                            <option value="day">Past 24 Hours</option>
                            <option value="week">Past Week</option>
                            <option value="month">Past Month</option>
                            <option value="year">Past Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="media-type">Media Type:</label>
                        <select id="media-type" multiple>
                            <option value="all">All Types</option>
                            <option value="text">Text</option>
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                            <option value="news">News</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language">
                            <option value="all">All Languages</option>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="zh">Chinese</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="execute-search">Search</button>
                <div class="search-results" id="search-results">
                    <!-- Search results will be displayed here -->
                </div>
            </div>

            <div class="panel" id="cache-stats">
                <h2>Cache Statistics</h2>
                <p>Monitor cache performance and optimize your searches.</p>
                <div class="cache-stats">
                    <div class="stats-card">
                        <h3>Cache Hit Rate</h3>
                        <div class="chart-container">
                            <canvas id="hit-rate-chart"></canvas>
                        </div>
                    </div>
                    <div class="stats-card">
                        <h3>Token Savings</h3>
                        <div class="value" id="token-savings">0</div>
                        <div class="description">Tokens saved through caching</div>
                    </div>
                    <div class="stats-card">
                        <h3>Cost Savings</h3>
                        <div class="value" id="cost-savings">$0.00</div>
                        <div class="description">Estimated cost savings</div>
                    </div>
                    <div class="stats-card">
                        <h3>Cache Efficiency</h3>
                        <div class="value" id="cache-efficiency">0%</div>
                        <div class="description">Overall cache efficiency</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="cache-ttl">Cache TTL (seconds):</label>
                    <input type="number" id="cache-ttl" value="3600">
                </div>
                <button class="btn" id="purge-cache">Purge Cache</button>
                <button class="btn" id="refresh-stats">Refresh Statistics</button>
            </div>
        </div>

        <section id="research-assistant">
            <h2>Research Assistant</h2>
            <div class="research-projects" id="research-projects">
                <!-- Research projects will be displayed here -->
            </div>
            <button class="btn" id="new-project">New Project</button>
            <button class="btn" id="save-query">Save Current Query</button>
            <div class="history-section">
                <h3>History</h3>
                <div class="history-list" id="history-list">
                    <!-- History items will be displayed here -->
                </div>
            </div>
            <div class="export-options">
                <h3>Export Options</h3>
                <button class="btn" id="export-apa">Export APA</button>
                <button class="btn" id="export-mla">Export MLA</button>
                <button class="btn" id="export-chicago">Export Chicago</button>
                <button class="btn" id="export-pdf">Export PDF</button>
            </div>
            <div class="fact-checking-section">
                <h3>Fact-Checking Tools</h3>
                <div class="form-group">
                    <label for="fact-check-query">Fact to Check:</label>
                    <textarea id="fact-check-query" placeholder="Enter the fact you want to verify"></textarea>
                </div>
                <button class="btn btn-primary" id="verify-fact">Verify Fact</button>
                <div class="fact-check-results" id="fact-check-results">
                    <!-- Fact-check results will be displayed here -->
                </div>
            </div>
            <div class="refresh-controls">
                <h3>Real-time Refresh</h3>
                <div class="refresh-indicator">
                    <div class="loading-spinner" id="refresh-spinner" style="display: none;"></div>
                    <span id="refresh-status">Ready</span>
                </div>
                <button class="btn" id="start-refresh">Start Refresh</button>
                <button class="btn" id="stop-refresh">Stop Refresh</button>
                <div class="form-group">
                    <label for="refresh-interval">Refresh Interval (seconds):</label>
                    <input type="number" id="refresh-interval" value="30">
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 Perplexity Research Hub. All rights reserved.</p>
    </footer>

    <script>
        // DOM elements
        const apiKeyInput = document.getElementById('api-key');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const totalRequestsEl = document.getElementById('total-requests');
        const tokensUsedEl = document.getElementById('tokens-used');
        const estimatedCostEl = document.getElementById('estimated-cost');

        const sonarModelSelect = document.getElementById('sonar-model');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInputEl = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message');
        const followUpQuestionsSelect = document.getElementById('follow-up-questions');
        const forkConversationBtn = document.getElementById('fork-conversation');
        const verifyCitationsBtn = document.getElementById('verify-citations');

        const searchQueryInput = document.getElementById('search-query');
        const domainFilterSelect = document.getElementById('domain-filter');
        const dateRangeSelect = document.getElementById('date-range');
        const mediaTypeSelect = document.getElementById('media-type');
        const languageSelect = document.getElementById('language');
        const executeSearchBtn = document.getElementById('execute-search');
        const searchResultsEl = document.getElementById('search-results');

        const hitRateChartEl = document.getElementById('hit-rate-chart');
        const tokenSavingsEl = document.getElementById('token-savings');
        const costSavingsEl = document.getElementById('cost-savings');
        const cacheEfficiencyEl = document.getElementById('cache-efficiency');
        const cacheTtlInput = document.getElementById('cache-ttl');
        const purgeCacheBtn = document.getElementById('purge-cache');
        const refreshStatsBtn = document.getElementById('refresh-stats');

        const researchProjectsEl = document.getElementById('research-projects');
        const newProjectBtn = document.getElementById('new-project');
        const saveQueryBtn = document.getElementById('save-query');
        const historyListEl = document.getElementById('history-list');
        const exportApaBtn = document.getElementById('export-apa');
        const exportMlaBtn = document.getElementById('export-mla');
        const exportChicagoBtn = document.getElementById('export-chicago');
        const exportPdfBtn = document.getElementById('export-pdf');

        const factCheckQueryInput = document.getElementById('fact-check-query');
        const verifyFactBtn = document.getElementById('verify-fact');
        const factCheckResultsEl = document.getElementById('fact-check-results');

        const refreshSpinnerEl = document.getElementById('refresh-spinner');
        const refreshStatusEl = document.getElementById('refresh-status');
        const startRefreshBtn = document.getElementById('start-refresh');
        const stopRefreshBtn = document.getElementById('stop-refresh');
        const refreshIntervalInput = document.getElementById('refresh-interval');

        // State variables
        let apiKey = localStorage.getItem('apiKey') || '';
        let usageStats = JSON.parse(localStorage.getItem('usageStats')) || {
            totalRequests: 0,
            tokensUsed: 0,
            estimatedCost: 0
        };
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let currentChatId = null;
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
        let researchProjects = JSON.parse(localStorage.getItem('researchProjects')) || [];
        let currentProjectId = null;
        let refreshInterval = null;

        // Initialize the application
        function init() {
            // Set initial API key
            apiKeyInput.value = apiKey;

            // Update usage statistics display
            updateUsageStatsDisplay();

            // Initialize chat
            initChat();

            // Initialize search
            initSearch();

            // Initialize cache statistics
            initCacheStats();

            // Initialize research assistant
            initResearchAssistant();

            // Initialize fact-checking
            initFactChecking();

            // Initialize refresh controls
            initRefreshControls();

            // Load history
            loadHistory();

            // Load research projects
            loadResearchProjects();

            // Set up event listeners
            setupEventListeners();
        }

        // Initialize chat functionality
        function initChat() {
            if (chatHistory.length > 0) {
                currentChatId = chatHistory[0].id;
                displayChatMessages(chatHistory[0].messages);
            }
        }

        // Initialize search functionality
        function initSearch() {
            // Initialize search filters
            // (Additional initialization code would go here)
        }

        // Initialize cache statistics
        function initCacheStats() {
            // Initialize Chart.js for hit rate visualization
            const hitRateChart = new Chart(hitRateChartEl, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Cache Hit Rate',
                        data: [65, 59, 80, 81, 56, 55],
                        borderColor: '#90e0ef',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(144, 224, 239, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Update cache statistics display
            updateCacheStatsDisplay();
        }

        // Initialize research assistant
        function initResearchAssistant() {
            // (Additional initialization code would go here)
        }

        // Initialize fact-checking
        function initFactChecking() {
            // (Additional initialization code would go here)
        }

        // Initialize refresh controls
        function initRefreshControls() {
            // (Additional initialization code would go here)
        }

        // Load history from localStorage
        function loadHistory() {
            historyListEl.innerHTML = '';
            chatHistory.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                historyItem.textContent = chat.title || `Chat ${chat.id}`;
                historyItem.dataset.chatId = chat.id;
                historyListEl.appendChild(historyItem);
            });
        }

        // Load research projects from localStorage
        function loadResearchProjects() {
            researchProjectsEl.innerHTML = '';
            researchProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = `project-card ${project.id === currentProjectId ? 'active' : ''}`;
                projectCard.innerHTML = `
                    <h3>${project.name}</h3>
                    <p>${project.description || 'No description'}</p>
                `;
                projectCard.dataset.projectId = project.id;
                researchProjectsEl.appendChild(projectCard);
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // API key management
            saveApiKeyBtn.addEventListener('click', saveApiKey);

            // Sonar chat
            sendMessageBtn.addEventListener('click', sendMessage);
            chatInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            followUpQuestionsSelect.addEventListener('change', handleFollowUpQuestion);
            forkConversationBtn.addEventListener('click', forkConversation);
            verifyCitationsBtn.addEventListener('click', verifyCitations);

            // Search API
            executeSearchBtn.addEventListener('click', executeSearch);

            // Cache statistics
            purgeCacheBtn.addEventListener('click', purgeCache);
            refreshStatsBtn.addEventListener('click', fetchCacheStats);

            // Research assistant
            newProjectBtn.addEventListener('click', createNewProject);
            saveQueryBtn.addEventListener('click', saveCurrentQuery);
            exportApaBtn.addEventListener('click', exportApa);
            exportMlaBtn.addEventListener('click', exportMla);
            exportChicagoBtn.addEventListener('click', exportChicago);
            exportPdfBtn.addEventListener('click', exportPdf);

            // Fact-checking
            verifyFactBtn.addEventListener('click', verifyFact);

            // Refresh controls
            startRefreshBtn.addEventListener('click', startRefresh);
            stopRefreshBtn.addEventListener('click', stopRefresh);

            // History navigation
            historyListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('history-item')) {
                    const chatId = e.target.dataset.chatId;
                    loadChatHistory(chatId);
                }
            });

            // Project navigation
            researchProjectsEl.addEventListener('click', (e) => {
                const projectCard = e.target.closest('.project-card');
                if (projectCard) {
                    const projectId = projectCard.dataset.projectId;
                    loadResearchProject(projectId);
                }
            });
        }

        // Save API key
        function saveApiKey() {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('apiKey', apiKey);
            alert('API key saved successfully!');
        }

        // Update usage statistics display
        function updateUsageStatsDisplay() {
            totalRequestsEl.textContent = usageStats.totalRequests;
            tokensUsedEl.textContent = usageStats.tokensUsed;
            estimatedCostEl.textContent = `$${usageStats.estimatedCost.toFixed(2)}`;
        }

        // Send message in Sonar chat
        async function sendMessage() {
            const message = chatInputEl.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessageToChat('user', message);
            chatInputEl.value = '';

            // Show loading indicator
            addMessageToChat('bot', '...');

            try {
                // Simulate API call to Perplexity Sonar endpoint
                const response = await simulateSonarApiCall(message);

                // Remove loading indicator
                removeLastBotMessage();

                // Add bot response to chat
                addMessageToChat('bot', response.content, response.citations);

                // Update follow-up questions
                updateFollowUpQuestions(response.followUpQuestions);

                // Update usage statistics
                usageStats.totalRequests++;
                usageStats.tokensUsed += response.tokensUsed;
                usageStats.estimatedCost += response.estimatedCost;
                localStorage.setItem('usageStats', JSON.stringify(usageStats));
                updateUsageStatsDisplay();

                // Save chat history
                saveChatHistory();
            } catch (error) {
                console.error('Error:', error);
                removeLastBotMessage();
                addMessageToChat('bot', 'Sorry, there was an error processing your request.');
            }
        }

        // Simulate API call to Perplexity Sonar endpoint
        async function simulateSonarApiCall(message) {
            // In a real application, this would be an actual API call to the Perplexity Sonar endpoint
            // For this example, we'll simulate the response

            return new Promise((resolve) => {
                setTimeout(() => {
                    const response = {
                        content: `This is a simulated response to your message: "${message}". The Perplexity Sonar API would provide a more detailed and contextually relevant answer here.`,
                        citations: [
                            { id: 1, url: 'https://example.com/source1', credibility: 'high' },
                            { id: 2, url: 'https://example.com/source2', credibility: 'medium' }
                        ],
                        followUpQuestions: [
                            'What are the key points of this response?',
                            'Can you provide more details on this topic?',
                            'Are there any alternative perspectives?'
                        ],
                        tokensUsed: Math.floor(Math.random() * 100) + 50,
                        estimatedCost: parseFloat((Math.random() * 0.1).toFixed(4))
                    };
                    resolve(response);
                }, 1000);
            });
        }

        // Add message to chat
        function addMessageToChat(sender, content, citations = []) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}-message`;

            // Add message content
            messageEl.innerHTML = `<p>${content}</p>`;

            // Add citations if they exist
            if (citations.length > 0) {
                const citationsEl = document.createElement('div');
                citationsEl.className = 'citations';

                citations.forEach(citation => {
                    const badge = document.createElement('span');
                    badge.className = `citation-badge ${citation.credibility}-credibility`;
                    badge.textContent = citation.id;
                    badge.dataset.url = citation.url;
                    badge.addEventListener('click', () => {
                        window.open(citation.url, '_blank');
                    });

                    const indicator = document.createElement('span');
                    indicator.className = `credibility-indicator ${citation.credibility}-credibility`;

                    badge.prepend(indicator);
                    citationsEl.appendChild(badge);
                });

                messageEl.appendChild(citationsEl);
            }

            chatMessagesEl.appendChild(messageEl);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        // Remove the last bot message (used for loading indicators)
        function removeLastBotMessage() {
            const messages = chatMessagesEl.querySelectorAll('.message');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.classList.contains('bot-message')) {
                    chatMessagesEl.removeChild(lastMessage);
                }
            }
        }

        // Update follow-up questions
        function updateFollowUpQuestions(questions) {
            followUpQuestionsSelect.innerHTML = '';
            questions.forEach(question => {
                const option = document.createElement('option');
                option.value = question;
                option.textContent = question;
                followUpQuestionsSelect.appendChild(option);
            });
        }

        // Handle follow-up question selection
        function handleFollowUpQuestion() {
            const selectedQuestion = followUpQuestionsSelect.value;
            if (selectedQuestion) {
                chatInputEl.value = selectedQuestion;
                sendMessage();
            }
        }

        // Fork conversation
        function forkConversation() {
            // In a real application, this would create a new conversation branch
            // For this example, we'll just create a new chat
            createNewChat();
            alert('Conversation forked! A new chat has been created.');
        }

        // Verify citations
        function verifyCitations() {
            // In a real application, this would verify the citations in the current chat
            // For this example, we'll just show a message
            alert('Citations verified! In a real application, this would show detailed verification results.');
        }

        // Execute search
        async function executeSearch() {
            const query = searchQueryInput.value.trim();
            if (!query) return;

            // Show loading indicator
            searchResultsEl.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Simulate API call to Perplexity Search endpoint
                const results = await simulateSearchApiCall(query);

                // Remove loading indicator
                searchResultsEl.innerHTML = '';

                // Display search results
                displaySearchResults(results);

                // Update usage statistics
                usageStats.totalRequests++;
                usageStats.tokensUsed += results.tokensUsed;
                usageStats.estimatedCost += results.estimatedCost;
                localStorage.setItem('usageStats', JSON.stringify(usageStats));
                updateUsageStatsDisplay();

                // Save search history
                saveSearchHistory(query, results);
            } catch (error) {
                console.error('Error:', error);
                searchResultsEl.innerHTML = '<p>Sorry, there was an error processing your search.</p>';
            }
        }

        // Simulate API call to Perplexity Search endpoint
        async function simulateSearchApiCall(query) {
            // In a real application, this would be an actual API call to the Perplexity Search endpoint
            // For this example, we'll simulate the response

            return new Promise((resolve) => {
                setTimeout(() => {
                    const results = Array.from({ length: 5 }, (_, i) => ({
                        id: i + 1,
                        title: `Result ${i + 1} for "${query}"`,
                        snippet: `This is a simulated search result for your query: "${query}". The Perplexity Search API would provide more relevant and detailed results here.`,
                        url: `https://example.com/result${i + 1}`,
                        credibility: ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
                        date: new Date(Date.now() - Math.floor(Math.random() * 30) * 24 * 60 * 60 * 1000).toLocaleDateString()
                    }));

                    const response = {
                        results: results,
                        tokensUsed: Math.floor(Math.random() * 50) + 20,
                        estimatedCost: parseFloat((Math.random() * 0.05).toFixed(4))
                    };
                    resolve(response);
                }, 1000);
            });
        }

        // Display search results
        function displaySearchResults(results) {
            results.results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'search-result';

                const credibilityClass = result.credibility === 'high' ? 'high-credibility' :
                                        result.credibility === 'medium' ? 'medium-credibility' : 'low-credibility';

                resultEl.innerHTML = `
                    <h3>${result.title}</h3>
                    <p>${result.snippet}</p>
                    <div class="url">${result.url}</div>
                    <div class="meta">
                        <span class="credibility-indicator ${credibilityClass}"></span>
                        <span class="date">${result.date}</span>
                    </div>
                `;

                searchResultsEl.appendChild(resultEl);
            });
        }

        // Purge cache
        function purgeCache() {
            // In a real application, this would purge the cache
            // For this example, we'll just show a message
            alert('Cache purged! In a real application, this would clear the cache and update the statistics.');
            fetchCacheStats();
        }

        // Fetch cache statistics
        async function fetchCacheStats() {
            // Show loading indicator
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'loading-spinner';
            document.querySelector('.cache-stats').appendChild(loadingSpinner);

            try {
                // Simulate API call to get cache statistics
                const stats = await simulateCacheStatsApiCall();

                // Remove loading indicator
                document.querySelector('.cache-stats').removeChild(loadingSpinner);

                // Update cache statistics display
                updateCacheStatsDisplay(stats);
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('.cache-stats').removeChild(loadingSpinner);
                alert('Error fetching cache statistics');
            }
        }

        // Simulate API call to get cache statistics
        async function simulateCacheStatsApiCall() {
            // In a real application, this would be an actual API call to get cache statistics
            // For this example, we'll simulate the response

            return new Promise((resolve) => {
                setTimeout(() => {
                    const stats = {
                        hitRate: Math.floor(Math.random() * 100),
                        tokenSavings: Math.floor(Math.random() * 10000),
                        costSavings: parseFloat((Math.random() * 10).toFixed(2)),
                        cacheEfficiency: Math.floor(Math.random() * 100)
                    };
                    resolve(stats);
                }, 1000);
            });
        }

        // Update cache statistics display
        function updateCacheStatsDisplay(stats) {
            if (stats) {
                tokenSavingsEl.textContent = stats.tokenSavings;
                costSavingsEl.textContent = `$${stats.costSavings}`;
                cacheEfficiencyEl.textContent = `${stats.cacheEfficiency}%`;
            }
        }

        // Create new project
        function createNewProject() {
            const projectName = prompt('Enter project name:');
            if (projectName) {
                const project = {
                    id: Date.now().toString(),
                    name: projectName,
                    description: '',
                    queries: [],
                    createdAt: new Date().toISOString()
                };

                researchProjects.push(project);
                localStorage.setItem('researchProjects', JSON.stringify(researchProjects));
                loadResearchProjects();
                currentProjectId = project.id;
                loadResearchProject(currentProjectId);
            }
        }

        // Save current query
        function saveCurrentQuery() {
            if (!currentProjectId) {
                alert('Please select or create a research project first.');
                return;
            }

            const query = {
                id: Date.now().toString(),
                title: prompt('Enter query title:') || 'Untitled Query',
                content: searchQueryInput.value.trim(),
                createdAt: new Date().toISOString()
            };

            const projectIndex = researchProjects.findIndex(p => p.id === currentProjectId);
            if (projectIndex !== -1) {
                researchProjects[projectIndex].queries.push(query);
                localStorage.setItem('researchProjects', JSON.stringify(researchProjects));
                alert('Query saved successfully!');
            }
        }

        // Export APA
        function exportApa() {
            // In a real application, this would export the current research in APA format
            // For this example, we'll just show a message
            alert('APA export would be generated here. In a real application, this would download a properly formatted APA document.');
        }

        // Export MLA
        function exportMla() {
            // In a real application, this would export the current research in MLA format
            // For this example, we'll just show a message
            alert('MLA export would be generated here. In a real application, this would download a properly formatted MLA document.');
        }

        // Export Chicago
        function exportChicago() {
            // In a real application, this would export the current research in Chicago format
            // For this example, we'll just show a message
            alert('Chicago export would be generated here. In a real application, this would download a properly formatted Chicago document.');
        }

        // Export PDF
        function exportPdf() {
            // In a real application, this would export the current research as a PDF
            // For this example, we'll just show a message
            alert('PDF export would be generated here. In a real application, this would download a PDF document with annotated sources.');
        }

        // Verify fact
        async function verifyFact() {
            const fact = factCheckQueryInput.value.trim();
            if (!fact) return;

            // Show loading indicator
            factCheckResultsEl.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Simulate API call to verify the fact
                const verification = await simulateFactCheckApiCall(fact);

                // Remove loading indicator
                factCheckResultsEl.innerHTML = '';

                // Display verification results
                displayFactCheckResults(verification);
            } catch (error) {
                console.error('Error:', error);
                factCheckResultsEl.innerHTML = '<p>Sorry, there was an error verifying the fact.</p>';
            }
        }

        // Simulate API call to verify a fact
        async function simulateFactCheckApiCall(fact) {
            // In a real application, this would be an actual API call to verify the fact
            // For this example, we'll simulate the response

            return new Promise((resolve) => {
                setTimeout(() => {
                    const verification = {
                        fact: fact,
                        verdict: ['true', 'misleading', 'false'][Math.floor(Math.random() * 3)],
                        sources: Array.from({ length: 3 }, (_, i) => ({
                            id: i + 1,
                            url: `https://example.com/source${i + 1}`,
                            credibility: ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
                            snippet: `This is a simulated source for the fact: "${fact}". The fact-checking API would provide more detailed information here.`
                        })),
                        lastUpdated: new Date().toLocaleString()
                    };
                    resolve(verification);
                }, 1000);
            });
        }

        // Display fact-check results
        function displayFactCheckResults(verification) {
            const resultEl = document.createElement('div');
            resultEl.className = 'fact-check-item';

            const verdictClass = verification.verdict === 'true' ? 'true' :
                                verification.verdict === 'misleading' ? 'misleading' : 'false';

            resultEl.innerHTML = `
                <h3>Fact Check Results</h3>
                <p>${verification.fact}</p>
                <div class="verdict ${verdictClass}">${verification.verdict.toUpperCase()}</div>
                <p>Last updated: ${verification.lastUpdated}</p>
                <h4>Sources:</h4>
            `;

            verification.sources.forEach(source => {
                const credibilityClass = source.credibility === 'high' ? 'high-credibility' :
                                        source.credibility === 'medium' ? 'medium-credibility' : 'low-credibility';

                const sourceEl = document.createElement('div');
                sourceEl.className = 'source';
                sourceEl.innerHTML = `
                    <div class="source-link">
                        <span class="credibility-indicator ${credibilityClass}"></span>
                        <a href="${source.url}" target="_blank">${source.url}</a>
                    </div>
                    <p>${source.snippet}</p>
                `;

                resultEl.appendChild(sourceEl);
            });

            factCheckResultsEl.appendChild(resultEl);
        }

        // Start refresh
        function startRefresh() {
            const interval = parseInt(refreshIntervalInput.value) * 1000;
            if (interval < 1000) {
                alert('Refresh interval must be at least 1 second.');
                return;
            }

            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            refreshSpinnerEl.style.display = 'inline-block';
            refreshStatusEl.textContent = 'Refreshing...';

            // Start the refresh interval
            refreshInterval = setInterval(() => {
                refreshData();
            }, interval);
        }

        // Stop refresh
        function stopRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }

            refreshSpinnerEl.style.display = 'none';
            refreshStatusEl.textContent = 'Stopped';
        }

        // Refresh data
        async function refreshData() {
            refreshStatusEl.textContent = 'Refreshing...';

            try {
                // Refresh all relevant data
                await Promise.all([
                    fetchCacheStats(),
                    // Add other refresh operations as needed
                ]);

                refreshStatusEl.textContent = 'Refreshed';
                setTimeout(() => {
                    refreshStatusEl.textContent = 'Ready';
                }, 2000);
            } catch (error) {
                console.error('Error refreshing data:', error);
                refreshStatusEl.textContent = 'Error';
            }
        }

        // Load chat history
        function loadChatHistory(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (chat) {
                currentChatId = chatId;
                displayChatMessages(chat.messages);
                loadHistory();
            }
        }

        // Display chat messages
        function displayChatMessages(messages) {
            chatMessagesEl.innerHTML = '';
            messages.forEach(message => {
                addMessageToChat(message.sender, message.content, message.citations || []);
            });
        }

        // Save chat history
        function saveChatHistory() {
            const messages = Array.from(chatMessagesEl.querySelectorAll('.message')).map(messageEl => {
                const sender = messageEl.classList.contains('user-message') ? 'user' : 'bot';
                const content = messageEl.querySelector('p').textContent;
                const citations = Array.from(messageEl.querySelectorAll('.citation-badge')).map(badge => ({
                    id: parseInt(badge.textContent),
                    url: badge.dataset.url,
                    credibility: badge.classList.contains('high-credibility') ? 'high' :
                                badge.classList.contains('medium-credibility') ? 'medium' : 'low'
                }));

                return { sender, content, citations };
            });

            if (currentChatId) {
                const chatIndex = chatHistory.findIndex(c => c.id === currentChatId);
                if (chatIndex !== -1) {
                    chatHistory[chatIndex].messages = messages;
                }
            } else {
                const newChat = {
                    id: Date.now().toString(),
                    title: messages[0]?.content.substring(0, 30) + '...' || 'New Chat',
                    messages: messages
                };
                chatHistory.unshift(newChat);
                currentChatId = newChat.id;
            }

            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            loadHistory();
        }

        // Create new chat
        function createNewChat() {
            currentChatId = null;
            chatMessagesEl.innerHTML = '';
            loadHistory();
        }

        // Load research project
        function loadResearchProject(projectId) {
            const project = researchProjects.find(p => p.id === projectId);
            if (project) {
                currentProjectId = projectId;
                // In a real application, this would load the project data and display it
                // For this example, we'll just update the active project
                loadResearchProjects();
            }
        }

        // Save search history
        function saveSearchHistory(query, results) {
            const search = {
                id: Date.now().toString(),
                query: query,
                results: results.results,
                createdAt: new Date().toISOString()
            };

            searchHistory.unshift(search);
            if (searchHistory.length > 50) {
                searchHistory.pop();
            }

            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>